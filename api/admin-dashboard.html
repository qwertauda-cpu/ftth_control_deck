<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>لوحة التحكم الإدارية - إدارة الوكيلين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN warning in console
        (function() {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) {
                    return; // Suppress Tailwind CDN warning
                }
                originalWarn.apply(console, args);
            };
        })();
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .table-row {
            transition: all 0.2s;
        }
        .table-row:hover {
            background-color: #f9fafb;
        }
        .insight-card {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile Optimizations */
        @media (max-width: 768px) {
            * {
                -webkit-tap-highlight-color: rgba(59, 130, 246, 0.1);
            }
            
            body {
                overflow-x: hidden;
                -webkit-font-smoothing: antialiased;
                background: linear-gradient(to bottom, #f9fafb 0%, #f3f4f6 100%);
            }
            
            .container {
                padding-left: 0 !important;
                padding-right: 0 !important;
                max-width: 100% !important;
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            /* Remove extra margins */
            * {
                box-sizing: border-box;
            }
            
            html, body {
                margin: 0 !important;
                padding: 0 !important;
                width: 100%;
                overflow-x: hidden;
            }
            
            .min-h-screen {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Header adjustments - sticky at top, no background on mobile */
            header {
                position: sticky;
                top: 0;
                z-index: 50;
                box-shadow: none;
                backdrop-filter: none;
                transition: transform 0.3s ease-in-out;
                transform: translateY(0);
            }
            
            header.header-hidden {
                transform: translateY(-100%);
                box-shadow: none;
            }
            
            /* No extra padding needed with sticky */
            body {
                padding-top: 0;
            }
            
            main {
                padding-top: 0 !important;
                margin-top: 0;
            }
            
            /* Simple header on mobile - just title and logout, no background */
            header {
                padding: 0.5rem 0.5rem !important;
                margin: 0 !important;
                border-radius: 0;
                width: 100%;
                background: transparent !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            
            header .container {
                gap: 0.5rem !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                margin: 0 !important;
                flex-direction: row !important;
                justify-content: space-between !important;
                align-items: center !important;
            }
            
            /* Hide icon on mobile */
            header .flex.items-center.gap-2 > div:first-child {
                display: none !important;
            }
            
            /* Hide description on mobile */
            header p {
                display: none !important;
            }
            
            /* Simple title */
            header h1 {
                font-size: 0.9rem !important;
                margin: 0 !important;
                font-weight: 600 !important;
                line-height: 1.2;
                color: #1f2937 !important;
            }
            
            /* Hide server status on mobile */
            header #server-status {
                display: none !important;
            }
            
            /* Simplify logout button - just text, no background */
            header button {
                padding: 0.4rem 0.75rem !important;
                font-size: 0.8rem !important;
                min-height: auto !important;
                background: transparent !important;
                border: 1px solid #e5e7eb !important;
                color: #dc2626 !important;
                border-radius: 0.375rem;
            }
            
            header button:hover {
                background: #fee2e2 !important;
                border-color: #dc2626 !important;
            }
            
            /* Hide SVG icon in logout button on mobile */
            header button svg {
                display: none !important;
            }
            
            /* Show only "خروج" text */
            header button span.md\\:hidden {
                display: inline !important;
            }
            
            header button span.hidden.md\\:inline {
                display: none !important;
            }
            
            /* Better spacing for main content */
            main {
                padding-top: 0.5rem !important;
                padding-bottom: 0.75rem !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                margin: 0 !important;
            }
            
            main > div {
                margin-bottom: 0.75rem;
            }
            
            /* Improve card spacing */
            .owner-card {
                margin-bottom: 0.75rem;
            }
            
            /* Better section spacing */
            .bg-white.rounded-xl {
                margin-bottom: 0.75rem;
                padding: 0.875rem !important;
            }
            
            /* Remove extra padding from sections */
            .bg-white.rounded-xl > div:first-child {
                padding: 0 !important;
                margin-bottom: 0.75rem !important;
            }
            
            header .container {
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }
            
            
            header .flex {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            /* Compact buttons in header */
            header button {
                padding: 0.5rem 0.875rem !important;
                font-size: 0.8rem !important;
                min-height: 36px;
            }
            
            header #server-status {
                padding: 0.375rem 0.75rem !important;
                font-size: 0.75rem !important;
            }
            
            /* Statistics cards - stack vertically on mobile */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            .stat-card {
                margin-bottom: 0;
                padding: 0.875rem !important;
                border-radius: 0.75rem;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
                transition: all 0.3s ease;
                border: 1px solid rgba(0,0,0,0.06);
            }
            
            .stat-card:active {
                transform: scale(0.98);
            }
            
            .stat-card .text-3xl {
                font-size: 1.875rem;
                font-weight: 700;
            }
            
            .stat-card .w-12 {
                width: 3rem;
                height: 3rem;
            }
            
            /* Hide table on mobile, show cards instead */
            #owners-table-container table {
                display: none;
            }
            
            /* Mobile cards container */
            #owners-mobile-cards {
                display: block;
            }
            
            .owner-card {
                background: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 0.875rem;
                margin-bottom: 0.75rem;
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }
            
            .owner-card::before {
                content: '';
                position: absolute;
                top: 0;
                right: 0;
                width: 4px;
                height: 100%;
                background: linear-gradient(to bottom, #3b82f6, #8b5cf6);
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            
            .owner-card:active {
                transform: translateY(-2px);
                box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            }
            
            .owner-card:active::before {
                opacity: 1;
            }
            
            .owner-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid #f3f4f6;
            }
            
            .owner-card-title {
                font-size: 1.1rem;
                font-weight: 700;
                color: #1f2937;
                line-height: 1.4;
            }
            
            .owner-card-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.375rem 0.875rem;
                border-radius: 9999px;
                font-size: 0.75rem;
                font-weight: 700;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .owner-card-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }
            
            .owner-card-item {
                display: flex;
                flex-direction: column;
                padding: 0.625rem;
                background: #f9fafb;
                border-radius: 0.625rem;
                transition: all 0.2s ease;
                border: 1px solid rgba(0,0,0,0.03);
            }
            
            .owner-card-item:active {
                background: #f3f4f6;
                transform: scale(0.98);
            }
            
            .owner-card-label {
                font-size: 0.7rem;
                color: #6b7280;
                margin-bottom: 0.5rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .owner-card-value {
                font-size: 0.95rem;
                font-weight: 700;
                color: #1f2937;
            }
            
            .owner-card-full {
                grid-column: 1 / -1;
            }
            
            /* Table container - hidden on mobile */
            .overflow-x-auto {
                display: none;
            }
            
            /* Better button styles */
            button {
                border-radius: 0.75rem;
                font-weight: 600;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                transition: all 0.2s ease;
            }
            
            button:active {
                transform: scale(0.96);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            /* Section titles */
            h2 {
                font-weight: 700;
                letter-spacing: -0.5px;
            }
            
            /* Loading spinner */
            .loading-spinner {
                border-width: 3px;
            }
            
            /* Better spacing */
            .p-6 {
                padding: 1.25rem;
            }
            
            .mb-6 {
                margin-bottom: 1.5rem;
            }
            
            .mb-4 {
                margin-bottom: 1.25rem;
            }
            
            /* Cards section */
            .bg-white {
                border-radius: 0.75rem;
                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
                border: 1px solid rgba(0,0,0,0.06);
            }
            
            /* Better section headers */
            .bg-white.rounded-xl > div:first-child {
                padding: 0.75rem 0 !important;
                margin-bottom: 0.75rem !important;
                border-bottom: 1px solid #f3f4f6;
            }
            
            /* Section titles */
            .bg-white.rounded-xl h2 {
                font-size: 1.1rem !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .bg-white.rounded-xl p {
                font-size: 0.8rem !important;
                margin: 0.25rem 0 0 0 !important;
            }
            
            /* Improve text readability */
            body {
                font-size: 0.9rem;
                line-height: 1.6;
            }
            
            /* Better button spacing */
            button + button {
                margin-right: 0.5rem;
            }
            
            /* Remove gaps from grid */
            .grid.gap-3 {
                gap: 0.75rem !important;
            }
            
            /* Improve header appearance */
            header {
                background: linear-gradient(135deg, #26466D 0%, #1e3550 100%) !important;
                border-bottom: 2px solid rgba(255,255,255,0.1);
            }
            
            /* Better text contrast */
            header h1 {
                color: #ffffff !important;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }
            
            header p {
                color: rgba(255,255,255,0.9) !important;
            }
            
            /* Ensure no gaps anywhere */
            body > div {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Remove default margins from all elements */
            * {
                margin: 0;
            }
            
            /* Only add margins where needed */
            main > div:not(:last-child) {
                margin-bottom: 0.75rem;
            }
            
            /* Buttons - better mobile UX */
            button {
                min-height: 44px;
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
                touch-action: manipulation;
            }
            
            /* Modal adjustments */
            #pages-modal {
                padding: 0.5rem;
            }
            
            #pages-modal > div {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                max-height: 100vh;
                border-radius: 0.75rem;
            }
            
            /* Modal header */
            #pages-modal .bg-gradient-to-r {
                padding: 1rem !important;
            }
            
            #pages-modal h3 {
                font-size: 1.1rem;
            }
            
            /* Modal content */
            #pages-modal-content {
                padding: 0.75rem !important;
            }
            
            /* Page cards in modal */
            .bg-gray-50 {
                padding: 0.75rem !important;
                margin-bottom: 0.5rem;
            }
            
            /* Text sizes */
            .text-2xl {
                font-size: 1.25rem;
            }
            
            .text-xl {
                font-size: 1rem;
            }
            
            .text-lg {
                font-size: 0.95rem;
            }
            
            /* Spacing adjustments */
            .p-6 {
                padding: 1rem;
            }
            
            .p-3 {
                padding: 0.75rem;
            }
            
            .mb-8 {
                margin-bottom: 1.5rem;
            }
            
            .mb-6 {
                margin-bottom: 1.25rem;
            }
            
            .mb-4 {
                margin-bottom: 1rem;
            }
            
            .gap-6 {
                gap: 1rem;
            }
            
            .gap-3 {
                gap: 0.75rem;
            }
            
            /* Loading spinner */
            .loading-spinner {
                width: 32px;
                height: 32px;
                border-width: 2px;
            }
            
            /* Cards */
            .rounded-xl {
                border-radius: 0.75rem;
            }
            
            /* Password display */
            .font-mono {
                font-size: 0.7rem;
                word-break: break-all;
            }
            
            /* Better touch targets */
            .cursor-pointer {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
        }
        
        /* Desktop - show table, hide cards */
        @media (min-width: 769px) {
            #owners-table-container table {
                display: table;
            }
            
            #owners-mobile-cards {
                display: none;
            }
            
            .overflow-x-auto {
                display: block;
            }
        }
        
        /* Small phones */
        @media (max-width: 480px) {
            .owner-card {
                padding: 1rem;
                border-radius: 0.875rem;
            }
            
            .owner-card-title {
                font-size: 1rem;
            }
            
            .owner-card-body {
                gap: 0.875rem;
            }
            
            .owner-card-item {
                padding: 0.625rem;
            }
            
            .text-3xl {
                font-size: 1.75rem;
            }
            
            header h1 {
                font-size: 1.05rem;
            }
            
            header p {
                font-size: 0.65rem;
            }
            
            .stat-card {
                padding: 1.125rem !important;
            }
            
            .stat-card .text-3xl {
                font-size: 1.75rem;
            }
            
            button {
                font-size: 0.875rem;
                padding: 0.625rem 1rem;
            }
        }
        
        /* Very small phones */
        @media (max-width: 360px) {
            .owner-card {
                padding: 0.875rem;
                border-radius: 0.75rem;
            }
            
            .owner-card-body {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .owner-card-item {
                padding: 0.625rem;
            }
            
            .text-3xl {
                font-size: 1.5rem;
            }
            
            .stat-card {
                padding: 1rem !important;
            }
            
            .stat-card .text-3xl {
                font-size: 1.5rem;
            }
        }
        
        /* Touch-friendly buttons */
        @media (hover: none) and (pointer: coarse) {
            button, a, .cursor-pointer {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Remove hover effects on touch devices */
            .stat-card:hover {
                transform: none;
            }
            
            .table-row:hover {
                background-color: transparent;
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            header {
                position: relative;
            }
            
            .stat-card {
                padding: 0.75rem !important;
            }
            
            .stat-card .text-3xl {
                font-size: 1.5rem;
            }
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Prevent text selection on buttons */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Better focus states for accessibility */
        button:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white md:bg-gradient-to-r md:from-[#26466D] md:to-[#1e3550] text-gray-800 md:text-white p-3 md:p-4 md:shadow-lg">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-0">
                <div class="flex items-center gap-2 md:gap-3">
                    <div class="w-8 h-8 md:w-10 md:h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-bold">لوحة التحكم الإدارية</h1>
                        <p class="text-xs md:text-sm text-blue-100">إدارة الوكيلين والأنظمة</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto justify-between md:justify-end">
                    <span id="server-status" class="px-2 md:px-3 py-1 rounded-full text-xs md:text-sm bg-green-500 flex items-center gap-1 md:gap-2">
                        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        <span class="hidden md:inline">متصل</span>
                    </span>
                    <button onclick="logout()" class="px-3 md:px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-colors flex items-center gap-1 md:gap-2 text-sm md:text-base">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                        <span class="hidden md:inline">تسجيل الخروج</span>
                        <span class="md:hidden">خروج</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-2 md:p-6" style="padding-left: 0.5rem; padding-right: 0.5rem;">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-4 md:mb-8">
                <div class="stat-card bg-white rounded-xl shadow-md md:shadow-lg p-4 md:p-6 border-l-4 border-blue-500 active:scale-[0.98] transition-transform">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-600 text-xs md:text-sm mb-1 truncate">إجمالي الوكيلين</p>
                            <p id="stat-total-owners" class="text-2xl md:text-3xl font-bold text-blue-600">0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 md:w-6 md:h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-md md:shadow-lg p-4 md:p-6 border-l-4 border-green-500 active:scale-[0.98] transition-transform">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-600 text-xs md:text-sm mb-1 truncate">الوكيلين النشطين</p>
                            <p id="stat-active-owners" class="text-2xl md:text-3xl font-bold text-green-600">0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 md:w-6 md:h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-md md:shadow-lg p-4 md:p-6 border-l-4 border-purple-500 active:scale-[0.98] transition-transform">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-600 text-xs md:text-sm mb-1 truncate">إجمالي صفحات الوطني</p>
                            <p id="stat-total-pages" class="text-2xl md:text-3xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 md:w-6 md:h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="stat-card bg-white rounded-xl shadow-md md:shadow-lg p-4 md:p-6 border-l-4 border-orange-500 active:scale-[0.98] transition-transform">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <p class="text-gray-600 text-xs md:text-sm mb-1 truncate">متوسط الأيام</p>
                            <p id="stat-avg-days" class="text-2xl md:text-3xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="w-10 h-10 md:w-12 md:h-12 bg-orange-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 md:w-6 md:h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Owners Table -->
            <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 mb-4 md:mb-6">
                <div class="flex justify-between items-center mb-4 md:mb-6">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">جدول الوكيلين</h2>
                        <p class="text-gray-600 text-xs md:text-sm mt-1">عرض جميع الوكيلين المسجلين في النظام</p>
                    </div>
                    <button onclick="loadOwnersList()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        تحديث
                    </button>
                </div>
                
                <div id="owners-loading" class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600 text-sm">جاري تحميل البيانات...</p>
                </div>
                
                <div id="owners-table-container" class="hidden overflow-x-auto -mx-3 md:mx-0" style="-webkit-overflow-scrolling: touch; scrollbar-width: thin;">
                    <div class="md:hidden mb-2 text-xs text-gray-500 text-center">
                        <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path>
                        </svg>
                        اسحب لليمين لعرض المزيد
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">اسم الوكيل</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">رقم الهاتف</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">كلمة المرور</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">صفحات</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">الأيام</th>
                                <th class="px-2 md:px-6 py-2 md:py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">المستخدم</th>
                            </tr>
                        </thead>
                        <tbody id="owners-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Cards Container -->
                <div id="owners-mobile-cards" class="md:hidden space-y-3">
                    <!-- Mobile cards will be loaded here -->
                </div>
            </div>

            <!-- Manager Chat Section -->
            <div class="bg-white rounded-xl shadow-lg p-3 md:p-6 mb-4 md:mb-6">
                <div class="flex items-center justify-between gap-2 md:gap-3 mb-3 md:mb-6">
                    <div class="flex items-center gap-2 md:gap-3">
                        <div class="w-8 h-8 md:w-10 md:h-10 bg-gradient-to-br from-blue-400 to-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 md:w-6 md:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg md:text-2xl font-bold text-gray-800">شات المدير</h2>
                            <p class="text-gray-600 text-xs md:text-sm">تواصل مع المدير والاقتراحات</p>
                        </div>
                    </div>
                    <button onclick="showManageParticipants()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <span class="hidden md:inline">إدارة المشاركين</span>
                    </button>
                </div>

                <!-- Chat Container -->
                <div class="flex flex-col md:flex-row gap-4" style="height: 500px;">
                    <!-- Chat Messages Area -->
                    <div class="flex-1 flex flex-col border border-gray-200 rounded-lg overflow-hidden">
                        <!-- Messages Header -->
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm font-semibold text-gray-700">المحادثة</span>
                            </div>
                            <button onclick="refreshChat()" class="text-gray-500 hover:text-gray-700 transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Messages List -->
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                            <div class="text-center py-8 text-gray-500 text-sm">
                                جاري تحميل الرسائل...
                            </div>
                        </div>
                        
                        <!-- Message Input -->
                        <div class="border-t border-gray-200 bg-white p-3">
                            <div class="flex items-end gap-2">
                                <label class="cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                    <input type="file" id="chat-image-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </label>
                                <textarea id="chat-message-input" placeholder="اكتب رسالتك هنا..." 
                                    class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    rows="1" onkeydown="handleChatKeyDown(event)"></textarea>
                                <button onclick="sendChatMessage()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
                                    إرسال
                                </button>
                            </div>
                            <div id="chat-image-preview" class="hidden mt-2">
                                <div class="relative inline-block">
                                    <img id="chat-preview-img" src="" alt="Preview" class="max-w-xs rounded-lg border border-gray-300">
                                    <button onclick="cancelImageUpload()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                                        ×
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Participants Sidebar -->
                    <div class="w-full md:w-64 border border-gray-200 rounded-lg overflow-hidden flex flex-col">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                            <h3 class="text-sm font-semibold text-gray-700">المشاركون</h3>
                        </div>
                        <div id="chat-participants" class="flex-1 overflow-y-auto p-3 space-y-2">
                            <div class="text-center py-4 text-gray-500 text-xs">جاري التحميل...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Alwatani Pages -->
    <div id="pages-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 flex justify-between items-center">
                <div>
                    <h3 id="modal-owner-name" class="text-2xl font-bold">صفحات الوطني</h3>
                    <p id="modal-owner-pages-count" class="text-purple-100 text-sm mt-1">جاري التحميل...</p>
                </div>
                <button onclick="closePagesModal()" class="text-white hover:text-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="pages-modal-loading" class="flex-1 overflow-y-auto p-6">
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">جاري تحميل صفحات الوطني...</p>
                </div>
            </div>
            
            <div id="pages-modal-content" class="hidden flex-1 overflow-y-auto p-6">
                <div id="pages-list" class="space-y-3">
                    <!-- Pages will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('admin_token');
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Check authentication
        if (!authToken) {
            console.log('[ADMIN] No token found, redirecting to login');
            window.location.href = '/admin-login.html';
            throw new Error('Redirecting to login');
        }
        
        if (typeof authToken !== 'string' || authToken.trim() === '') {
            console.log('[ADMIN] Invalid token format, redirecting to login');
            localStorage.removeItem('admin_token');
            window.location.href = '/admin-login.html';
            throw new Error('Invalid token');
        }

        // Load owners list
        async function loadOwnersList() {
            const loadingDiv = document.getElementById('owners-loading');
            const container = document.getElementById('owners-table-container');
            const tbody = document.getElementById('owners-table-body');
            const mobileCards = document.getElementById('owners-mobile-cards');
            
            loadingDiv.classList.remove('hidden');
            container.classList.add('hidden');
            if (mobileCards) mobileCards.innerHTML = '';
            tbody.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/api/admin/owners/list`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    console.error('[ADMIN] API Error:', response.status, response.statusText);
                    if (response.status === 401) {
                        localStorage.removeItem('admin_token');
                        window.location.href = '/admin-login.html';
                        return;
                    }
                }
                
                const data = await response.json();
                console.log('[ADMIN] Owners list response:', data);
                
                if (!data.success) {
                    console.error('[ADMIN] API returned error:', data.error || data.message);
                    loadingDiv.classList.add('hidden');
                    container.classList.remove('hidden');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-8 text-center text-red-500">
                                خطأ في جلب البيانات: ${data.error || data.message || 'خطأ غير معروف'}
                            </td>
                        </tr>
                    `;
                    if (mobileCards) {
                        mobileCards.innerHTML = `
                            <div class="text-center py-8 text-red-500 text-sm">
                                خطأ في جلب البيانات: ${data.error || data.message || 'خطأ غير معروف'}
                            </div>
                        `;
                    }
                    return;
                }
                
                if (data.success && data.owners) {
                    loadingDiv.classList.add('hidden');
                    container.classList.remove('hidden');
                    
                    if (data.owners.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                    لا يوجد وكلاء مسجلين في النظام
                                </td>
                            </tr>
                        `;
                        if (mobileCards) {
                            mobileCards.innerHTML = `
                                <div class="text-center py-8 text-gray-500 text-sm">
                                    لا يوجد وكلاء مسجلين في النظام
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Render table rows (desktop)
                    data.owners.forEach((owner, index) => {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-semibold">${owner.agent_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${owner.phone}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <button onclick="showAlwataniPages(${owner.id}, '${owner.agent_name}', ${owner.alwatani_pages_count})" 
                                        class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full font-semibold hover:bg-purple-200 transition-colors cursor-pointer">
                                    ${owner.alwatani_pages_count}
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="px-3 py-1 rounded-full font-semibold ${owner.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${owner.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full font-semibold">${owner.days_used} يوم</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${owner.username}</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Render mobile cards
                    if (mobileCards) {
                        mobileCards.innerHTML = '';
                        data.owners.forEach((owner, index) => {
                            const card = document.createElement('div');
                            card.className = 'owner-card';
                            const passwordId = `mobile-owner-password-${owner.id}`;
                            const toggleId = `mobile-owner-toggle-${owner.id}`;
                            card.innerHTML = `
                                <div class="owner-card-header">
                                    <div class="owner-card-title">${owner.agent_name}</div>
                                    <span class="owner-card-badge ${owner.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${owner.status}
                                    </span>
                                </div>
                                <div class="owner-card-body">
                                    <div class="owner-card-item">
                                        <div class="owner-card-label">رقم الهاتف</div>
                                        <div class="owner-card-value font-mono">${owner.phone}</div>
                                    </div>
                                    <div class="owner-card-item">
                                        <div class="owner-card-label">عدد صفحات الوطني</div>
                                        <div class="owner-card-value">
                                            <button onclick="showAlwataniPages(${owner.id}, '${owner.agent_name}', ${owner.alwatani_pages_count})" 
                                                    class="px-3 py-1 bg-purple-100 text-purple-800 rounded-full font-semibold text-sm">
                                                ${owner.alwatani_pages_count}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="owner-card-item">
                                        <div class="owner-card-label">عدد الأيام</div>
                                        <div class="owner-card-value">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">${owner.days_used} يوم</span>
                                        </div>
                                    </div>
                                    <div class="owner-card-item">
                                        <div class="owner-card-label">اسم المستخدم</div>
                                        <div class="owner-card-value font-mono text-sm">${owner.username}</div>
                                    </div>
                                    <div class="owner-card-item owner-card-full">
                                        <div class="owner-card-label">كلمة مرور الحساب</div>
                                        <div class="flex items-center gap-2 mt-1">
                                            <div id="${passwordId}" class="flex-1 px-3 py-2 bg-gray-100 rounded-lg font-mono text-sm text-center">
                                                ${owner.password ? '*'.repeat(owner.password.length) : '*'.repeat(8)}
                                            </div>
                                            <button id="${toggleId}" onclick="toggleOwnerPasswordMobile(${owner.id}, ${owner.password ? JSON.stringify(owner.password).replace(/"/g, '&quot;') : 'null'})" 
                                                    class="px-3 py-2 bg-blue-500 text-white rounded-lg text-xs font-semibold">
                                                إظهار
                                            </button>
                                            <button onclick="copyOwnerPasswordMobile(${owner.password ? JSON.stringify(owner.password).replace(/"/g, '&quot;') : 'null'}, this)" 
                                                    class="px-3 py-2 bg-green-500 text-white rounded-lg text-xs font-semibold">
                                                نسخ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            mobileCards.appendChild(card);
                        });
                    }
                    
                    // Update statistics
                    updateStatistics(data.owners);
                } else {
                    loadingDiv.classList.add('hidden');
                    container.classList.remove('hidden');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-8 text-center text-red-500">
                                خطأ في تحميل البيانات: ${data.error || 'خطأ غير معروف'}
                            </td>
                        </tr>
                    `;
                    if (mobileCards) {
                        mobileCards.innerHTML = `
                            <div class="text-center py-8 text-red-500 text-sm">
                                خطأ في تحميل البيانات: ${data.error || 'خطأ غير معروف'}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading owners:', error);
                loadingDiv.classList.add('hidden');
                container.classList.remove('hidden');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-red-500">
                            خطأ في الاتصال بالسيرفر: ${error.message}
                        </td>
                    </tr>
                `;
                if (mobileCards) {
                    mobileCards.innerHTML = `
                        <div class="text-center py-8 text-red-500 text-sm">
                            خطأ في الاتصال بالسيرفر: ${error.message}
                        </div>
                    `;
                }
            }
        }
        
        // Toggle owner password visibility (Mobile)
        function toggleOwnerPasswordMobile(ownerId, password) {
            const passwordElement = document.getElementById(`mobile-owner-password-${ownerId}`);
            const toggleButton = document.getElementById(`mobile-owner-toggle-${ownerId}`);
            
            if (!passwordElement || !toggleButton) {
                console.error('Password element or toggle button not found', { ownerId, passwordElement, toggleButton });
                return;
            }
            
            // Handle null, undefined, or empty password
            if (!password || password === 'null' || password === 'undefined' || password === '' || password === null) {
                alert('لا توجد كلمة مرور متاحة');
                return;
            }
            
            // Decode HTML entities if needed
            if (password.includes('&quot;')) {
                password = password.replace(/&quot;/g, '"');
            }
            
            const currentText = passwordElement.textContent.trim();
            const isHidden = currentText.includes('*') || currentText === '';
            
            if (isHidden) {
                // Show password
                passwordElement.textContent = password;
                toggleButton.textContent = 'إخفاء';
                passwordElement.classList.remove('bg-gray-100');
                passwordElement.classList.add('bg-yellow-100', 'text-yellow-900');
            } else {
                // Hide password
                passwordElement.textContent = '*'.repeat(password.length || 8);
                toggleButton.textContent = 'إظهار';
                passwordElement.classList.remove('bg-yellow-100', 'text-yellow-900');
                passwordElement.classList.add('bg-gray-100');
            }
        }
        
        // Copy owner password (Mobile)
        function copyOwnerPasswordMobile(password, buttonElement) {
            // Handle null, undefined, or empty password
            if (!password || password === 'null' || password === 'undefined' || password === '' || password === null) {
                alert('لا توجد كلمة مرور للنسخ');
                return;
            }
            
            // Decode HTML entities if needed
            if (password.includes('&quot;')) {
                password = password.replace(/&quot;/g, '"');
            }
            
            navigator.clipboard.writeText(password).then(() => {
                // Show temporary success message
                const button = buttonElement || window.event?.target;
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = 'تم النسخ!';
                    button.classList.remove('bg-green-500');
                    button.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600');
                        button.classList.add('bg-green-500');
                    }, 2000);
                } else {
                    // Fallback: show toast message
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.textContent = 'تم نسخ كلمة المرور بنجاح!';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                }
            }).catch(err => {
                console.error('Failed to copy password:', err);
                alert('فشل نسخ كلمة المرور');
            });
        }

        // Update statistics
        function updateStatistics(owners) {
            const totalOwners = owners.length;
            const activeOwners = owners.filter(o => o.is_active).length;
            const totalPages = owners.reduce((sum, o) => sum + (o.alwatani_pages_count || 0), 0);
            const avgDays = owners.length > 0 ? Math.round(owners.reduce((sum, o) => sum + (o.days_used || 0), 0) / owners.length) : 0;
            
            document.getElementById('stat-total-owners').textContent = totalOwners;
            document.getElementById('stat-active-owners').textContent = activeOwners;
            document.getElementById('stat-total-pages').textContent = totalPages;
            document.getElementById('stat-avg-days').textContent = avgDays;
        }

        // Chat Functions
        let currentUserId = 1; // Admin user ID
        let chatRefreshInterval = null;
        let selectedImageFile = null;
        
        // Load chat messages
        async function loadChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            
            try {
                const response = await fetch(`${API_URL}/api/admin/chat/messages`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.messages) {
                    messagesContainer.innerHTML = '';
                    
                    if (data.messages.length === 0) {
                        messagesContainer.innerHTML = `
                            <div class="text-center py-8 text-gray-500 text-sm">
                                لا توجد رسائل بعد. ابدأ المحادثة!
                            </div>
                        `;
                        return;
                    }
                    
                    data.messages.forEach(msg => {
                        const isOwnMessage = msg.sender_id === currentUserId;
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
                        
                        messageDiv.innerHTML = `
                            <div class="max-w-xs md:max-w-md ${isOwnMessage ? 'bg-blue-600 text-white' : 'bg-white border border-gray-200'} rounded-lg p-3 shadow-sm">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs font-semibold ${isOwnMessage ? 'text-blue-100' : 'text-gray-600'}">${msg.sender_name}</span>
                                    <span class="text-xs ${isOwnMessage ? 'text-blue-200' : 'text-gray-400'}">${new Date(msg.created_at).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}</span>
                                </div>
                                ${msg.message_type === 'image' ? `
                                    <img src="${msg.file_url}" alt="Image" class="rounded-lg mb-2 max-w-full">
                                ` : ''}
                                <p class="text-sm ${isOwnMessage ? 'text-white' : 'text-gray-800'}">${msg.message}</p>
                            </div>
                        `;
                        messagesContainer.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat messages:', error);
                messagesContainer.innerHTML = `
                    <div class="text-center py-8 text-red-500 text-sm">
                        خطأ في تحميل الرسائل: ${error.message}
                    </div>
                `;
            }
        }
        
        // Load chat participants
        async function loadChatParticipants() {
            const participantsContainer = document.getElementById('chat-participants');
            
            try {
                const response = await fetch(`${API_URL}/api/admin/chat/participants`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.participants) {
                    participantsContainer.innerHTML = '';
                    
                    data.participants.forEach(participant => {
                        const participantDiv = document.createElement('div');
                        participantDiv.className = 'flex items-center gap-2 p-2 rounded-lg hover:bg-gray-50 transition-colors';
                        participantDiv.innerHTML = `
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                                ${participant.display_name ? participant.display_name.charAt(0) : participant.username.charAt(0)}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-semibold text-gray-800 truncate">${participant.display_name || participant.username}</p>
                                <p class="text-xs text-gray-500">${participant.role === 'admin' ? 'مدير' : participant.role === 'manager' ? 'مدير' : 'مستخدم'}</p>
                            </div>
                            ${participant.is_active ? '<div class="w-2 h-2 bg-green-500 rounded-full"></div>' : ''}
                        `;
                        participantsContainer.appendChild(participantDiv);
                    });
                }
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }
        
        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chat-message-input');
            const message = input.value.trim();
            
            if (!message && !selectedImageFile) {
                return;
            }
            
            const formData = new FormData();
            formData.append('message', message || '');
            if (selectedImageFile) {
                formData.append('image', selectedImageFile);
            }
            
            try {
                const response = await fetch(`${API_URL}/api/admin/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    input.value = '';
                    cancelImageUpload();
                    await loadChatMessages();
                } else {
                    alert('فشل إرسال الرسالة: ' + (data.error || 'خطأ غير معروف'));
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('فشل إرسال الرسالة');
            }
        }
        
        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('الرجاء اختيار صورة فقط');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('حجم الصورة يجب أن يكون أقل من 5 ميجابايت');
                return;
            }
            
            selectedImageFile = file;
            const preview = document.getElementById('chat-image-preview');
            const previewImg = document.getElementById('chat-preview-img');
            preview.classList.remove('hidden');
            previewImg.src = URL.createObjectURL(file);
        }
        
        // Cancel image upload
        function cancelImageUpload() {
            selectedImageFile = null;
            document.getElementById('chat-image-input').value = '';
            document.getElementById('chat-image-preview').classList.add('hidden');
        }
        
        // Handle chat key down
        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }
        
        // Refresh chat
        function refreshChat() {
            loadChatMessages();
            loadChatParticipants();
        }
        
        // Show manage participants modal
        function showManageParticipants() {
            alert('قريباً: إدارة المشاركين');
        }

        // Show Alwatani Pages Modal
        async function showAlwataniPages(ownerId, ownerName, pagesCount) {
            const modal = document.getElementById('pages-modal');
            const modalOwnerName = document.getElementById('modal-owner-name');
            const modalPagesCount = document.getElementById('modal-owner-pages-count');
            const loadingDiv = document.getElementById('pages-modal-loading');
            const contentDiv = document.getElementById('pages-modal-content');
            const pagesList = document.getElementById('pages-list');
            
            // التحقق من وجود العناصر
            if (!modal || !modalOwnerName || !modalPagesCount || !loadingDiv || !contentDiv || !pagesList) {
                console.error('[MODAL] Missing modal elements');
                alert('خطأ: عناصر الـ modal غير موجودة. يرجى تحديث الصفحة.');
                return;
            }
            
            modal.classList.remove('hidden');
            modalOwnerName.textContent = `صفحات الوطني - ${ownerName}`;
            modalPagesCount.textContent = `عدد الصفحات: ${pagesCount}`;
            
            loadingDiv.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            pagesList.innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/api/admin/owners/${ownerId}/alwatani-pages`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                
                if (data.success && data.pages) {
                    loadingDiv.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                    
                    if (data.pages.length === 0) {
                        pagesList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-lg">لا توجد صفحات وطني مسجلة</p>
                            </div>
                        `;
                        return;
                    }
                    
                    data.pages.forEach((page, index) => {
                        const pageCard = document.createElement('div');
                        pageCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow';
                        pageCard.innerHTML = `
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs font-bold">#${index + 1}</span>
                                        <h4 class="font-bold text-gray-800">${page.username || 'غير محدد'}</h4>
                                    </div>
                                    <div class="mt-2 space-y-2 text-xs md:text-sm">
                                        <div class="flex flex-col md:flex-row items-start md:items-center gap-2">
                                            <span class="font-semibold text-gray-700 whitespace-nowrap">كلمة المرور:</span>
                                            <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                                                <span id="password-${page.id}" class="font-mono text-gray-800 bg-gray-100 px-2 py-1 rounded text-xs md:text-sm break-all">${'*'.repeat(page.password ? page.password.length : 8)}</span>
                                                <button onclick="togglePassword(${page.id}, '${(page.password || '').replace(/'/g, "\\'")}')" 
                                                        class="text-blue-600 hover:text-blue-800 text-xs px-2 py-1 border border-blue-300 rounded hover:bg-blue-50 transition-colors whitespace-nowrap" style="min-height: 32px;">
                                                    <span id="toggle-text-${page.id}">إظهار</span>
                                                </button>
                                                <button onclick="copyPassword('${(page.password || '').replace(/'/g, "\\'")}')" 
                                                        class="text-green-600 hover:text-green-800 text-xs px-2 py-1 border border-green-300 rounded hover:bg-green-50 transition-colors whitespace-nowrap" style="min-height: 32px;">
                                                    نسخ
                                                </button>
                                            </div>
                                        </div>
                                        ${page.user_info ? `
                                            <div class="mt-2 space-y-1 text-sm text-gray-600">
                                                <p><span class="font-semibold">المستخدم:</span> ${page.user_info.agent_name || page.user_info.username || 'غير محدد'}</p>
                                                ${page.user_info.phone ? `<p><span class="font-semibold">الهاتف:</span> ${page.user_info.phone}</p>` : ''}
                                                ${page.user_info.email ? `<p><span class="font-semibold">البريد:</span> ${page.user_info.email}</p>` : ''}
                                            </div>
                                        ` : '<p class="text-sm text-gray-500 mt-2">لا يوجد مستخدم مرتبط</p>'}
                                    </div>
                                    <div class="mt-3 flex gap-4 text-xs text-gray-500">
                                        <span>تاريخ الإنشاء: ${new Date(page.created_at).toLocaleDateString('ar-EG')}</span>
                                        ${page.updated_at ? `<span>آخر تحديث: ${new Date(page.updated_at).toLocaleDateString('ar-EG')}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        pagesList.appendChild(pageCard);
                    });
                } else {
                    loadingDiv.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                    pagesList.innerHTML = `
                        <div class="text-center py-8 text-red-500">
                            <p>خطأ في تحميل البيانات: ${data.error || 'خطأ غير معروف'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading alwatani pages:', error);
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                pagesList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p>خطأ في الاتصال بالسيرفر: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Toggle owner password visibility
        function toggleOwnerPassword(ownerId, password) {
            const passwordElement = document.getElementById(`owner-password-${ownerId}`);
            const toggleButton = document.getElementById(`owner-toggle-${ownerId}`);
            
            if (passwordElement && toggleButton) {
                if (passwordElement.textContent.includes('*')) {
                    // Show password
                    passwordElement.textContent = password;
                    toggleButton.textContent = 'إخفاء';
                    passwordElement.classList.remove('bg-gray-100');
                    passwordElement.classList.add('bg-yellow-100', 'text-yellow-900');
                } else {
                    // Hide password
                    passwordElement.textContent = '*'.repeat(password.length || 8);
                    toggleButton.textContent = 'إظهار';
                    passwordElement.classList.remove('bg-yellow-100', 'text-yellow-900');
                    passwordElement.classList.add('bg-gray-100');
                }
            }
        }

        // Copy owner password to clipboard
        function copyOwnerPassword(password) {
            if (!password) {
                alert('لا توجد كلمة مرور للنسخ');
                return;
            }
            
            navigator.clipboard.writeText(password).then(() => {
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = 'تم نسخ كلمة المرور بنجاح!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy password:', err);
                alert('فشل نسخ كلمة المرور');
            });
        }

        // Toggle password visibility
        function togglePassword(pageId, password) {
            const passwordElement = document.getElementById(`password-${pageId}`);
            const toggleText = document.getElementById(`toggle-text-${pageId}`);
            
            if (passwordElement && toggleText) {
                if (passwordElement.textContent.includes('*')) {
                    // Show password
                    passwordElement.textContent = password;
                    toggleText.textContent = 'إخفاء';
                    passwordElement.classList.remove('bg-gray-100');
                    passwordElement.classList.add('bg-yellow-100', 'text-yellow-900');
                } else {
                    // Hide password
                    passwordElement.textContent = '*'.repeat(password.length || 8);
                    toggleText.textContent = 'إظهار';
                    passwordElement.classList.remove('bg-yellow-100', 'text-yellow-900');
                    passwordElement.classList.add('bg-gray-100');
                }
            }
        }

        // Copy password to clipboard
        function copyPassword(password) {
            if (!password) {
                alert('لا توجد كلمة مرور للنسخ');
                return;
            }
            
            navigator.clipboard.writeText(password).then(() => {
                // Show success message
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                toast.textContent = 'تم نسخ كلمة المرور بنجاح!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy password:', err);
                alert('فشل نسخ كلمة المرور');
            });
        }

        // Close Pages Modal
        function closePagesModal() {
            const modal = document.getElementById('pages-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('admin_token');
            window.location.href = '/admin-login.html';
        }

        // Header auto-hide on scroll (mobile only)
        let lastScrollTop = 0;
        let scrollTimeout;
        const header = document.querySelector('header');
        
        function handleScroll() {
            // Only apply on mobile
            if (window.innerWidth > 768) {
                if (header) header.classList.remove('header-hidden');
                return;
            }
            
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            clearTimeout(scrollTimeout);
            
            if (scrollTop > 100) { // Only hide after scrolling past 100px
                if (scrollTop > lastScrollTop) {
                    // Scrolling down - hide header
                    if (header) header.classList.add('header-hidden');
                } else {
                    // Scrolling up - show header
                    if (header) header.classList.remove('header-hidden');
                }
            } else {
                // Near top - always show
                if (header) header.classList.remove('header-hidden');
            }
            
            lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            
            // Show header after scrolling stops
            scrollTimeout = setTimeout(() => {
                if (header && scrollTop > 100) {
                    header.classList.remove('header-hidden');
                }
            }, 1500);
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Close modal on outside click
            const pagesModal = document.getElementById('pages-modal');
            if (pagesModal) {
                pagesModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closePagesModal();
                    }
                });
            }
            
            // Add scroll listener for header auto-hide
            let ticking = false;
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    window.requestAnimationFrame(function() {
                        handleScroll();
                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (header && window.innerWidth > 768) {
                    header.classList.remove('header-hidden');
                }
            });
            
            // Initial load
            loadOwnersList();
            loadChatMessages();
            loadChatParticipants();
            
            // Auto-refresh chat every 5 seconds
            chatRefreshInterval = setInterval(() => {
                loadChatMessages();
            }, 5000);
            
            // Auto-refresh owners every 60 seconds
            setInterval(() => {
                loadOwnersList();
            }, 60000);
        });
    </script>
</body>
</html>
